{% extends 'base.html' %}

{% block title %}Search matters {% endblock %}

{% block container %}

<div class='flex mt-2 place-content-between'> 
  <form method="POST" action="{% url 'display_data_index_page' %}">
    {% csrf_token %}
    <div class="md:flex grid md:w-fit div-container gap-2 md:gap-0">
      
        <div class="flex ">
            <select id="searchBy" name="searchBy" 
            class="py-2 px-1 text-sm font-medium text-center text-gray-900 bg-gray-100 
            border md:border-e-0  border-gray-300 dark:border-gray-700 dark:text-white rounded md:rounded-s md:rounded-e-none
            w-full hover:bg-gray-200 focus:ring-4 focus:outline-none  dark:bg-gray-600 dark:hover:bg-gray-700 dark:focus:ring-gray-800">
                <option value="FileNumber" {% if search_by == 'FileNumber' %}selected{% endif %}>Alpha Code</option>
                <option value="ClientName" {% if search_by == 'ClientName' %}selected{% endif %}>Client Name</option>
                <option value="FeeEarner" {% if search_by == 'FeeEarner' %}selected{% endif %}>FeeEarner</option>
                <option value="ToBeClosed" {% if search_by == 'ToBeClosed' %}selected{% endif %}>
                    Files to be Closed
                </option>
            </select>
        </div>
        <div class="md:me-2">
            <input
                id="valToSearch"
                name="valToSearch"
                class="border border-gray-300  text-gray-900 text-sm rounded md:rounded-none md:rounded-e focus:ring-blue-100 focus:border-blue-100 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500;"
                placeholder="Search Value"
                value="{{ val_to_search }}"
            />
        </div>
        <div class="md:me-2 flex items-center gap-1">
            
            <input type="checkbox" name="showArchived" {% if show_archived %}checked{% endif %} />
            <label>Show Archived Files</label>
        </div>
        <div class=" flex items-center">
            <button type="submit" class="btn-primary w-full ">Search</button>
        </div>
    </div> 
  </form>

  <div class='div-container h-fit'>
    <form method="POST" action="{% url 'download_search_report' %}">
      {% csrf_token %}
      
        <select hidden id="searchBy" name="searchBy" 
        class="py-2 px-1 text-sm font-medium text-center text-gray-900 bg-gray-100 
        border md:border-e-0  border-gray-300 dark:border-gray-700 dark:text-white rounded md:rounded-s md:rounded-e-none
        w-full hover:bg-gray-200 focus:ring-4 focus:outline-none  dark:bg-gray-600 dark:hover:bg-gray-700 dark:focus:ring-gray-800">
            <option value="FileNumber" {% if search_by == 'FileNumber' %}selected{% endif %}>Alpha Code</option>
            <option value="ClientName" {% if search_by == 'ClientName' %}selected{% endif %}>Client Name</option>
            <option value="FeeEarner" {% if search_by == 'FeeEarner' %}selected{% endif %}>FeeEarner</option>
            <option value="ToBeClosed" {% if search_by == 'ToBeClosed' %}selected{% endif %}>
                Files to be Closed
            </option>
        </select>

        <input 
            id="valToSearch"
            name="valToSearch"
            class="hidden border border-gray-300  text-gray-900 text-sm rounded md:rounded-none md:rounded-e focus:ring-blue-100 focus:border-blue-100 w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500;"
            placeholder="Search Value"
            value="{{ val_to_search }}"
        />


        <input hidden type="checkbox" name="showArchived" {% if show_archived %}checked{% endif %} />
        <button class='btn-primary'>Download</button>
    </form>
  </div>
</div>

<div class='div-container mt-4 w-full '>
  {% if data %}
  <div class='rounded-lg relative overflow-x-auto w-full'>
    <table
      id="tblUser"
      
      class=" w-full"
      >
      <thead class='mt-2 thead'>
        <tr>
          <!-- Adjust the headers based on your model fields -->
          <th class='td'>File Number</th>
          <th class='td'>Fee Earner</th>
          <th class='td'>Matter Description</th>
          <th class='td'>Client 1 Name</th>
          <th class='td'>Client 2 Name</th>
          <th class='td'>Last Work Done By</th>
          <th class='td'>Desc Of Last Work</th>
          <th class='td'>Date Of Last Work</th>

          <th class='td'>Comments</th>
        </tr>
      </thead>
      <tbody class='text-sm'>
        {% for row in data %}
        <tr class='tbody-striped'>
          <!-- Adjust the table cells based on your model fields -->
          <td class='td'>
            <a class='link' href="{% url 'home' row.file_number %}"
              >{{ row.file_number }}</a
            >
          </td>
          <td class='td'>{{ row.fee_earner__username|default:'-' }}</td>
          <td class='td'>{{ row.matter_description|default:'-' }}</td>
          <td class='td'>{{ row.client1__name|default:'-' }}</td>
          <td class='td'>{{ row.client2__name|default:'-' }}</td>
          <td class='td'>{{ row.latest_last_work_person|default:'-' }}</td>
          <td class='td'>{{ row.latest_last_work_task|default:'-' }}</td>
          <td class='td'>{{ row.latest_last_work_date|date:"d/m/Y"|default:'-' }}</td>
          <td class='td comment-cell' data-file-number="{{ row.file_number }}">
            <div class="comment-display">
              <span class="comment-text">{{ row.comments|default:'-' }}</span>
              <button class="ml-2 text-blue-600 hover:text-blue-800 edit-comment-btn" title="Edit comment">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
            </div>
            <div class="comment-edit hidden">
              <textarea class="comment-textarea w-full p-2 border border-gray-300 rounded text-sm" rows="3">{{ row.comments|default:'' }}</textarea>
              <div class="mt-2 flex gap-2">
                <button class="save-comment-btn btn-primary text-xs py-1 px-3">Save</button>
                <button class="cancel-comment-btn bg-gray-500 hover:bg-gray-600 text-white text-xs py-1 px-3 rounded">Cancel</button>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  

  {% else %}
  <p class='p-4 rounded-lg bg-red-50 text-red-800 border '>No Matters found. Check your search values above.</p>
  {% endif %}
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
  // Get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Function to show toast notification
  function showToast(message, type = 'success') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toast-container';
      toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;';
      document.body.appendChild(toastContainer);
    }

    // Create toast element
    const toast = document.createElement('div');
    const bgColor = type === 'success' ? '#10b981' : '#ef4444';
    const icon = type === 'success' 
      ? '<svg style="width: 20px; height: 20px; flex-shrink: 0;" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>'
      : '<svg style="width: 20px; height: 20px; flex-shrink: 0;" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>';
    
    toast.style.cssText = `
      background-color: ${bgColor};
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 300px;
      max-width: 500px;
      opacity: 0;
      transform: translateX(400px);
      transition: all 0.3s ease;
    `;
    
    toast.innerHTML = `
      ${icon}
      <span style="flex: 1;">${message}</span>
    `;

    toastContainer.appendChild(toast);

    // Trigger animation
    setTimeout(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateX(0)';
    }, 10);

    // Auto remove after 3 seconds
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(400px)';
      setTimeout(() => {
        toast.remove();
        // Remove container if empty
        if (toastContainer.children.length === 0) {
          toastContainer.remove();
        }
      }, 300);
    }, 3000);
  }

  // Handle edit button clicks
  document.querySelectorAll('.edit-comment-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const cell = this.closest('.comment-cell');
      const displayDiv = cell.querySelector('.comment-display');
      const editDiv = cell.querySelector('.comment-edit');
      
      displayDiv.classList.add('hidden');
      editDiv.classList.remove('hidden');
    });
  });

  // Handle cancel button clicks
  document.querySelectorAll('.cancel-comment-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const cell = this.closest('.comment-cell');
      const displayDiv = cell.querySelector('.comment-display');
      const editDiv = cell.querySelector('.comment-edit');
      
      // Reset textarea to original value
      const originalText = cell.querySelector('.comment-text').textContent;
      const textarea = cell.querySelector('.comment-textarea');
      textarea.value = originalText === '-' ? '' : originalText;
      
      editDiv.classList.add('hidden');
      displayDiv.classList.remove('hidden');
    });
  });

  // Handle save button clicks
  document.querySelectorAll('.save-comment-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const cell = this.closest('.comment-cell');
      const fileNumber = cell.dataset.fileNumber;
      const textarea = cell.querySelector('.comment-textarea');
      const newComment = textarea.value;
      
      // Disable button during save
      this.disabled = true;
      this.textContent = 'Saving...';

      // Send AJAX request
      fetch('/update-comment/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
          file_number: fileNumber,
          comment: newComment
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update the display text
          const commentText = cell.querySelector('.comment-text');
          commentText.textContent = newComment || '-';
          
          // Switch back to display mode
          const displayDiv = cell.querySelector('.comment-display');
          const editDiv = cell.querySelector('.comment-edit');
          editDiv.classList.add('hidden');
          displayDiv.classList.remove('hidden');
          
          // Show success toast notification
          showToast('Comment saved successfully!', 'success');
        } else {
          showToast('Error saving comment: ' + (data.error || 'Unknown error'), 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Error saving comment. Please try again.', 'error');
      })
      .finally(() => {
        // Re-enable button
        this.disabled = false;
        this.textContent = 'Save';
      });
    });
  });
});
</script>

{% endblock %}
