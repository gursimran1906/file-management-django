{% extends 'base.html' %} {% block title %}Dashboard{% endblock %}
 {% block container %} {% load utils %} {% csrf_token %}
 <!-- Kanban Board -->
 <div id="kanban-container" class="mb-6">
   <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-4">
     <div class="flex items-center gap-4">
       <h2 class="text-2xl font-semibold text-gray-800">Task Board</h2>
       
       <!-- Filter Toggle -->
       <div class="flex items-center gap-2">
         <label class="relative inline-flex items-center cursor-pointer">
           <input 
             type="checkbox" 
             class="sr-only peer" 
             id="filter-created-by-me"
           >
           <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
         </label>
         <span class="text-sm text-gray-600">Show only tasks I created</span>
       </div>
     </div>

     <div class="flex items-center gap-2">
     <!-- Add Task Button -->
     <button
     id="add-task-btn"
     class="btn-primary flex items-center gap-2"
   >
     <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
     </svg>
     Add Task
   </button>
     <!-- Improved Minimize Button -->
     <button
       id="kanban-toggle"
       class="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-900 focus:z-10 focus:ring-2 focus:ring-blue-500 focus:text-blue-700 transition-all duration-200"
        >
       <svg id="toggle-icon" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
       </svg>
       <span id="toggle-text">Minimize</span>
     </button>
     </div>
   </div>
   
  <div id="kanban-board" class="div-container">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- To Do Column -->
      <div class="kanban-column">
        <div class="flex justify-between items-center mb-4">
          <div class="flex flex-col">
            <h3 class="text-lg font-medium text-gray-700 flex items-center">
              <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
              To Do
            </h3>
            <p class="text-xs text-gray-500 ml-5">Sorted by urgency & due date</p>
          </div>
          <span
            class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-sm"
            id="to-do-count"
            >0</span
          >
        </div>
        <div class="space-y-3 min-h-80" id="to-do-tasks">
          <!-- Tasks will be loaded here -->
        </div>
      </div>
      <!-- In Progress Column -->
      <div class="kanban-column">
        <div class="flex justify-between items-center mb-4">
          <div class="flex flex-col">
            <h3 class="text-lg font-medium text-gray-700 flex items-center">
              <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
              In Progress
            </h3>
            <p class="text-xs text-gray-500 ml-5">Sorted by urgency & due date</p>
          </div>
          <span
            class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-sm"
            id="in-progress-count"
            >0</span
          >
        </div>
        <div class="space-y-3 min-h-80" id="in-progress-tasks">
          <!-- Tasks will be loaded here -->
        </div>
      </div>
      <!-- Completed This Week Column -->
      <div class="kanban-column">
        <div class="flex justify-between items-center mb-4">
          <div class="flex flex-col">
            <h3 class="text-lg font-medium text-gray-700 flex items-center">
              <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
               Completed This Week
            </h3>
            <p class="text-xs text-gray-500 ml-5">Recently completed tasks</p>
          </div>
          <span
            class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm"
            id="completed-count"
            >0</span
          >
        </div>
        <div class="space-y-3 min-h-80" id="completed-tasks">
          <!-- Tasks will be loaded here -->
        </div>
      </div>
    </div>
  </div>
  <!-- Minimized state -->
  <div id="kanban-minimized" class="hidden">
    <div class="div-container py-4 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <span class="text-gray-700">Task Board:</span>
        <span
          class="bg-red-100 text-red-800 px-2 py-1 rounded text-sm"
          id="minimized-to-do-count"
          >0 To Do</span
        >
        <span
          class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm"
          id="minimized-in-progress-count"
          >0 In Progress</span
        >
        <span
          class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm"
          id="minimized-completed-count"
          >0 Completed</span
        >
      </div>
        <button
          id="kanban-expand"
          class="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-900 focus:z-10 focus:ring-2 focus:ring-blue-500 focus:text-blue-700 transition-all duration-200"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
          </svg>
          Expand
        </button>
    </div>
  </div>
</div>
<div class="h-full space-y-4">
  {% comment %}
  <div class="grid md:grid-cols-2 gap-4">
    <h1 class="div-container md:w-fit h-fit text-3xl font-medium">
      Hello 👋 {{ request.user.first_name }}
    </h1>
  </div>
  {% endcomment %}
  <div class="h-full md:h-1/3 grid grid-cols-1 md:grid-cols-9 gap-4">
    <!-- Recent Files -->
    <div class="overflow-y-scroll div-container md:col-span-3">
      <h2 class="text-xl mb-2">Files</h2>
      <div class="overflow-x-scroll rounded-lg border">
        <table class="text-gray-600 w-full">
          <tr
            class="w-full border-b rounded-t-lg even:bg-white odd:bg-gray-50 font-medium"
          >
            <td class="py-2 px-2">File number</td>
            <td class="py-2 px-2">Description</td>
            <td class="py-2 px-2">Client(s)</td>
          </tr>
          {% for file in files %}
          <tr
            class="{% if forloop.last %}rounded-b-lg border-b-0 {% endif %}border-b even:bg-white odd:bg-gray-50"
          >
            <td class="py-2 px-2">
              <a class="link" href="{% url 'home' file.file_number %}"
                >{{ file.file_number }}</a
              >
            </td>
            <td class="py-2 px-2">{{ file.matter_description }}</td>
            <td class="py-2 px-2">
              {{ file.client1.name }} {{ file.client2.name }}
            </td>
          </tr>
          {% empty %}
          <tr class="text-green-700">
            <td class="py-2 px-2" colspan="3">No files to show</td>
          </tr>
          {% endfor %}
        </table>
      </div>
    </div>
    <!-- Next Work -->
    <div class="overflow-scroll div-container md:col-span-3">
      <h2 class="text-xl mb-2">Upcoming Tasks</h2>
      <ul>
        {% for work in user_next_works %}
        <ul class="mt-4 list">
          <li class="list-item bg-gray-50 rounded-t-lg">
            File Number: {{ work.file_number }}
          </li>
          <li class="list-item">Task(s) Required: {{ work.task }}</li>
          <li class="list-item bg-gray-50">
            Date: {{ work.date|date:"d/m/Y" }}
          </li>
          <li class="list-item">
            Assigned on: {{ work.timestamp|date:"d/m/Y @ h:iA" }}
          </li>
          <li class="list-item bg-gray-50 rounded-b-lg">
            <a class="link" href="{% url 'edit_next_work' work.id %}">Edit</a>
          </li>
        </ul>
        {% endfor %}
      </ul>
    </div>
    <!-- Recent Emails -->
    <div class="overflow-scroll div-container md:col-span-3">
      <div class="mb-4 flex justify-between">
        <h2 class="text-xl">Emails</h2>
        <span
          class="text-sm text-right text-gray-500 p-2 rounded-lg align-middle"
          >Latest 100 emails</span
        >
      </div>
      <div
        id="accordion-color"
        data-accordion="collapse"
        data-active-classes="bg-blue-100 dark:bg-gray-800 text-blue-600 dark:text-white rounded-b-none"
      >
        {% for email in last_100_emails %}
        <h2 id="accordion-color-heading-{{ email.id }}">
          <button
            type="button"
            class="flex items-center justify-between text-left w-full p-4 rtl:text-right bg-white text-gray-900 border border-gray-200 {% if forloop.first %}rounded-t-lg{% endif %} {% if forloop.last %}rounded-b-lg{% endif %} hover:shadow dark:border-gray-700 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 gap-3"
            data-accordion-target="#accordion-color-body-{{ email.id }}"
            aria-expanded="false"
            aria-controls="accordion-color-body-{{ email.id }}"
          >
            {{ email.time|date:'d/m/Y @ H:i' }} Email {% if email.is_sent %} to
            {% with email.receiver|jsonify as receiver %} {{ receiver.0.emailAddress.name }} 
            {% endwith %} {% else %} from {% with email.sender|jsonify as sender %} {{ sender.emailAddress.name }} 
            {% endwith %} {% endif %} - Subject: {{ email.subject }}
            <svg
              data-accordion-icon
              class="w-3 h-3 rotate-180 shrink-0"
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 10 6"
            >
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5 5 1 1 5"
              />
            </svg>
          </button>
        </h2>
        <div
          id="accordion-color-body-{{ email.id }}"
          class="hidden overflow-scroll bg-white dark:bg-gray-900"
          aria-labelledby="accordion-color-heading-{{ email.id }}"
        >
          <div
            class="overflow-scroll {% if forloop.last %}rounded-b-lg shadow{% endif %} p-4 border border-gray-200 dark:border-gray-700"
          >
            <table class="w-full table-auto">
              <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                <td class="px-1 py-2">
                  <b>From:</b>
                </td>
                <td class="px-1 py-2 break-words">
                  {% with email.sender|jsonify as sender %}
                  <p class="break-words">
                    {{ sender.emailAddress.name }} ({{
                    sender.emailAddress.address }});
                  </p>
                  {% endwith %}
                </td>
              </tr>
              <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                <td class="px-1 py-2">
                  <b>To:</b>
                </td>
                <td class="px-1 py-2 break-words">
                  {% with email.receiver|jsonify as receivers %} {% for receiver in receivers %}
                  <p class="break-words">
                    {{ receiver.emailAddress.name }} ({{receiver.emailAddress.address }});
                  </p>
                  {% endfor %} {% endwith %}
                </td>
              </tr>
              <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                <td class="px-1 py-2">
                  <b>Time:</b>
                </td>
                <td class="px-1 py-2 break-words">
                  {{ email.time|date:'d/m/Y @ H:i' }}
                </td>
              </tr>
              <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                <td class="px-1 py-2 break-words">
                  <b>Subject:</b>
                </td>
                <td class="px-1 py-2 break-words">{{ email.subject }}</td>
              </tr>
              <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                <td class="px-1 py-2">
                  <b>Link:</b>
                </td>
                <td class="px-1 py-2 break-words">
                  <a class="link break-words" href="{{ email.link }}"
                    >See Email</a
                  >
                </td>
              </tr>
              <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                <td class="px-1 py-2">
                  <b>Body:</b>
                </td>
                <td class="px-1 py-2 break-words">{{ email.body }}</td>
              </tr>
            </table>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    <!-- Chart.js Visualization -->
    {% comment %}
    <div class="bg-white p-4 rounded-lg shadow-md col-span-1 lg:col-span-2">
      <h2 class="text-xl font-semibold mb-2">Work Statistics</h2>
      <canvas id="workChart"></canvas>
    </div>
    {% endcomment %}
  </div>
  <div class="h-full md:h-1/2 grid grid-cols-1 md:grid-cols-7 gap-4">
    <!-- Risk Assessment -->
    <div class="div-container md:col-span-2 overflow-scroll">
      <div class="mb-2 flex justify-between">
        <h2 class="text-xl">Risk Assessments</h2>
        <span class="text-sm text-gray-500 p-2 rounded-lg align-middle"
          >older than 11 months</span
        >
      </div>
      <ul class="rounded-lg">
        {% for file in risk_assessments_due_files %} {% if file.date_of_last_risk_assessment %}
        <li class="hover:bg-gray-50 border-b py-2">
          <a href="{% url 'home' file.file_number %}">{{ file.file_number }}</a>
          - {{ file.date_of_last_risk_assessment|date:"d/m/y" }}
        </li>
        {% else %}
        <li class="hover:bg-gray-50 border-b py-2">
          <a class="link" href="{% url 'home' file.file_number %}"
            >{{ file.file_number }}</a
          >
          - <span class="text-red-700">None done</span>
        </li>
        {% endif %} {% empty %}
        <li class="text-sm border-t border-b py-2 text-green-700">
          No Risk Assessments due
        </li>
        {% endfor %}
      </ul>
    </div>
    <!-- AML Checks Due -->
    <div class="div-container md:col-span-2 overflow-scroll">
      <div class="mb-2 flex justify-between">
        <h2 class="text-xl">AML Checks</h2>
        <span
          class="text-sm text-right text-gray-500 p-2 rounded-lg align-middle"
          >older than 11 months</span
        >
      </div>
      <ul>
        {% for check in aml_checks_due %}
        <li class="border-b py-2">
          <a class="link" href="{% url 'edit_client' check.client_id %}"
            >{{ check.client_name }}</a
          >
          - {{ check.date_of_last_aml|date:"d/m/Y" }}
        </li>
        {% empty %}
        <li class="text-sm border-t border-b py-2 text-green-700">
          No Client AML Checks Due
        </li>
        {% endfor %}
      </ul>
    </div>
    <!-- Overdue Invoices -->
    <div class="div-container md:col-span-3 overflow-scroll">
      <h2 class="text-xl mb-2">Overdue Invoices</h2>
      <ul>
        {% for invoice in unsettled_invoices %}
        <li class="border-b py-2">
          {{ invoice.file_number.file_number }} -
          <a class="link" href="{% url 'download_invoice' invoice.id %}"
            >{{ invoice.invoice_number }}</a
          >
          - {% for cost, cost_desc in invoice.our_costs|zip:invoice.our_costs_desc %} {{ cost_desc }} - {{
          cost }}
          <br />
          {% endfor %}
        </li>
        {% empty %}
        <li class="text-sm border-t border-b py-2 text-green-700">
          No Invoices Overdue
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- Add Task Modal -->
  <div id="add-task-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 xl:w-1/3 shadow-lg rounded-md bg-white">
      <!-- Modal Header -->
      <div class="flex justify-between items-center pb-3">
        <h3 class="text-lg font-semibold text-gray-900">Add New Task</h3>
        <button id="close-modal" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- Modal Body -->
      <div class="py-4">
        <form id="add-task-form">
          <!-- File Number -->
          <div class="mb-4">
            <label for="file_number" class="block text-sm font-medium text-gray-700 mb-2">File Number</label>
            <div class="relative">
              <input
                type="text"
                id="file_number_search"
                placeholder="Search for a file..."
                class="form-input pr-10"
                autocomplete="off"
              >
              <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </div>
              <!-- Hidden input to store the actual file ID -->
              <input type="hidden" id="file_number" name="file_number" required>
              
              
              <!-- Dropdown results -->
              <div id="file_dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-60 overflow-auto hidden">
                <div id="file_options" class="py-1">
                  <!-- Options will be populated via JavaScript -->
                </div>
                <div id="no_files_found" class="px-3 py-2 text-sm text-gray-500 hidden">
                  No files found
                </div>
              </div>
            </div>
          </div>

          <!-- Person (Assigned To) -->
          <div class="mb-4">
            <label for="person" class="block text-sm font-medium text-gray-700 mb-2">Assigned To</label>
            <select id="person" name="person" class="form-input" required>
              <option value="">Select a person...</option>
              <!-- Options will be populated via JavaScript -->
            </select>
          </div>

          <!-- Task Description -->
          <div class="mb-4">
            <label for="task" class="block text-sm font-medium text-gray-700 mb-2">Task Description</label>
            <textarea id="task" name="task" rows="3" class="form-input" placeholder="Describe the task..." required></textarea>
          </div>

          <!-- Due Date -->
          <div class="mb-4">
            <label for="date" class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
            <input type="date" id="date" name="date" class="form-input">
          </div>

          <!-- Urgency -->
          <div class="mb-4">
            <label for="urgency" class="block text-sm font-medium text-gray-700 mb-2">Urgency</label>
            <select id="urgency" name="urgency" class="form-input" required>
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>

          <!-- Status -->
          <div class="mb-6">
            <label for="status" class="block text-sm font-medium text-gray-700 mb-2">Status</label>
            <select id="status" name="status" class="form-input" required>
              <option value="to_do" selected>To Do</option>
              <option value="in_progress">In Progress</option>
              <option value="completed">Completed</option>
            </select>
          </div>

          <!-- Modal Footer -->
          <div class="flex justify-end gap-3">
            <button type="button" id="cancel-task" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
              Cancel
            </button>
            <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors">
              Create Task
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const kanbanBoard = document.getElementById('kanban-board');
        const kanbanMinimized = document.getElementById('kanban-minimized');
        const kanbanToggle = document.getElementById('kanban-toggle');
        const kanbanExpand = document.getElementById('kanban-expand');
        const toggleText = document.getElementById('toggle-text');
        const toggleIcon = document.getElementById('toggle-icon');
        const filterToggle = document.getElementById('filter-created-by-me');

        // Modal elements
        const addTaskBtn = document.getElementById('add-task-btn');
        const modal = document.getElementById('add-task-modal');
        const closeModal = document.getElementById('close-modal');
        const cancelTask = document.getElementById('cancel-task');
        const addTaskForm = document.getElementById('add-task-form');
        
        // File search elements
        const fileSearchInput = document.getElementById('file_number_search');
        const fileHiddenInput = document.getElementById('file_number');
        const fileDropdown = document.getElementById('file_dropdown');
        const fileOptions = document.getElementById('file_options');
        const noFilesFound = document.getElementById('no_files_found');
        
        // Store all files data
        let allFiles = [];

        // Task containers and counts
        const containers = {
            'to_do': document.getElementById('to-do-tasks'),
            'in_progress': document.getElementById('in-progress-tasks'),
            'completed': document.getElementById('completed-tasks')
        };

        const counts = {
            'to_do': document.getElementById('to-do-count'),
            'in_progress': document.getElementById('in-progress-count'),
            'completed': document.getElementById('completed-count')
        };

        const minimizedCounts = {
            'to_do': document.getElementById('minimized-to-do-count'),
            'in_progress': document.getElementById('minimized-in-progress-count'),
            'completed': document.getElementById('minimized-completed-count')
        };

        // Track loaded tasks per status
        const loadedTasks = {
            'to_do': 0,
            'in_progress': 0,
            'completed': 0
        };

        const totalTasks = {
            'to_do': 0,
            'in_progress': 0,
            'completed': 0
        };

        // Filter state
        let currentFilterState = false;

        // Cookie functions
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = name + '=' + value + ';expires=' + expires.toUTCString() + ';path=/';
        }

        function getCookie(name) {
            const nameEQ = name + '=';
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // Load initial tasks on page load
        loadInitialTasks();

        // Check if kanban should be minimized by default
        const isMinimized = getCookie('kanban_minimized');
        const hasPendingTasks = {{ has_pending_tasks|yesno:"true,false" }};

        // Show minimized if user previously minimized it AND has no pending tasks
        if (isMinimized === 'true' && !hasPendingTasks) {
            kanbanBoard.classList.add('hidden');
            kanbanMinimized.classList.remove('hidden');
            toggleText.textContent = 'Expand';
        }

        // Toggle functionality
        function toggleKanban() {
            const isCurrentlyMinimized = kanbanBoard.classList.contains('hidden');

            if (isCurrentlyMinimized) {
                // Expand
                kanbanBoard.classList.remove('hidden');
                kanbanMinimized.classList.add('hidden');
                toggleText.textContent = 'Minimize';
                toggleIcon.style.transform = 'rotate(0deg)';
                setCookie('kanban_minimized', 'false', 30);
            } else {
                // Minimize
                kanbanBoard.classList.add('hidden');
                kanbanMinimized.classList.remove('hidden');
                toggleText.textContent = 'Expand';
                toggleIcon.style.transform = 'rotate(180deg)';
                setCookie('kanban_minimized', 'true', 30);
            }
        }

        kanbanToggle.addEventListener('click', toggleKanban);
        kanbanExpand.addEventListener('click', toggleKanban);

        // Modal event listeners
        addTaskBtn.addEventListener('click', function() {
            modal.classList.remove('hidden');
            loadModalData();
        });

        closeModal.addEventListener('click', function() {
            modal.classList.add('hidden');
            resetForm();
        });

        cancelTask.addEventListener('click', function() {
            modal.classList.add('hidden');
            resetForm();
        });

        // Close modal when clicking outside
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.add('hidden');
                resetForm();
            }
        });


        // File search functionality
        if (fileSearchInput) {
            fileSearchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterFiles(searchTerm);
            });

            fileSearchInput.addEventListener('focus', function() {
                if (fileDropdown) {
                    fileDropdown.classList.remove('hidden');
                    filterFiles(this.value.toLowerCase());
                }
            });

            fileSearchInput.addEventListener('click', function() {
                if (fileDropdown) {
                    fileDropdown.classList.remove('hidden');
                    filterFiles(this.value.toLowerCase());
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#file_number_search') && !e.target.closest('#file_dropdown')) {
                    if (fileDropdown) {
                        fileDropdown.classList.add('hidden');
                    }
                }
            });
        }

        // Filter toggle event listener
        filterToggle.addEventListener('change', function() {
            currentFilterState = this.checked;
            // Clear all containers and reload tasks
            Object.keys(containers).forEach(status => {
                containers[status].innerHTML = '';
                loadedTasks[status] = 0;
            });
            loadInitialTasks();
        });

        // Task status update functionality
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('task-status-btn')) {
                const taskId = e.target.closest('.kanban-task').dataset.taskId;
                const newStatus = e.target.dataset.newStatus;

                updateTaskStatus(taskId, newStatus);
            }

            if (e.target.classList.contains('load-more-btn')) {
                const status = e.target.dataset.status;
                loadMoreTasks(status);
            }
        });

        // Load initial tasks
        function loadInitialTasks() {
            fetch('/load-initial-tasks/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    count: 5,
                    filter_created_by_me: currentFilterState
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {

                    // Load tasks for each status
                    Object.keys(data.tasks).forEach(status => {
                        const tasks = data.tasks[status];
                        const total = data.total_counts[status];

                        totalTasks[status] = total;
                        loadedTasks[status] = tasks.length;

                        // Update counts
                        updateTaskCounts(status, total);

                        // Render tasks
                        renderTasks(status, tasks);

                        // Add load more button if needed
                        if (total > tasks.length) {
                            addLoadMoreButton(status);
                        }
                    });
                } else {
                    console.error('Error loading initial tasks:', data.error);
                    // Show empty state on error
                    Object.keys(containers).forEach(status => {
                        showEmptyState(status);
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Show empty state on error
                Object.keys(containers).forEach(status => {
                    showEmptyState(status);
                });
            });
        }

        // Update task counts in UI
        function updateTaskCounts(status, total) {
            if (counts[status]) {
                counts[status].textContent = total;
            }
            if (minimizedCounts[status]) {
                const statusText = status === 'to_do' ? 'To Do' :
                                status === 'in_progress' ? 'In Progress' :
                                'Completed';
                minimizedCounts[status].textContent = `${total} ${statusText}`;
            }
        }

        // Render tasks in container
        function renderTasks(status, tasks) {
            const container = containers[status];
            if (!container) return;

            tasks.forEach(task => {
                const taskElement = createTaskElement(task, status);
                container.appendChild(taskElement);
            });

            if (tasks.length === 0) {
                showEmptyState(status);
            }
        }

        // Show empty state
        function showEmptyState(status) {
            const container = containers[status];
            if (!container) return;

            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'text-center text-gray-500 py-8';

            const emptyText = status === 'to_do' ? 'No tasks to do' :
                            status === 'in_progress' ? 'No tasks in progress' :
                            'No tasks completed this week';

            emptyDiv.innerHTML = `<p>${emptyText}</p>`;
            container.appendChild(emptyDiv);
        }


        // Add load more button
        function addLoadMoreButton(status) {
            const container = containers[status];
            if (!container) return;

            const loadMoreBtn = document.createElement('button');
            loadMoreBtn.className = 'load-more-btn w-full py-2 text-blue-600 hover:text-blue-800';
            loadMoreBtn.dataset.status = status;
            loadMoreBtn.textContent = 'Load More...';
            container.appendChild(loadMoreBtn);
        }

        // Update task status via AJAX
        function updateTaskStatus(taskId, newStatus) {
            fetch('/update-task-status/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    task_id: taskId,
                    status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload initial tasks to refresh the view
                    Object.keys(containers).forEach(status => {
                        containers[status].innerHTML = '';
                        loadedTasks[status] = 0;
                    });
                    loadInitialTasks();
                } else {
                    alert('Error updating task status: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating task status');
            });
        }

        // Load more tasks via AJAX
        function loadMoreTasks(status) {
            const offset = loadedTasks[status];

            fetch('/load-more-tasks/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    status: status,
                    offset: offset,
                    count: 3,
                    filter_created_by_me: currentFilterState
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const container = containers[status];
                    const loadMoreBtn = container.querySelector('.load-more-btn');

                    // Remove existing load more button
                    if (loadMoreBtn) {
                        loadMoreBtn.remove();
                    }

                    // Add new tasks
                    data.tasks.forEach(task => {
                        const taskElement = createTaskElement(task, status);
                        container.appendChild(taskElement);
                    });

                    // Update loaded count
                    loadedTasks[status] += data.tasks.length;

                    // Add load more button if there are more tasks
                    if (data.has_more) {
                        addLoadMoreButton(status);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // Create task element from data
        function createTaskElement(task, status) {
            const div = document.createElement('div');
            div.className = `kanban-task bg-white border-l-4 border-${getBorderColor(status, task.urgency)}-500 p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow`;
            div.dataset.taskId = task.id;
            div.dataset.status = status;

            if (status === 'completed') {
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-medium text-gray-800 truncate">${task.file_number}</h4>
                        <span class="text-sm text-gray-500 whitespace-nowrap ml-2">
                            ${task.timestamp ? formatDate(task.timestamp) : ''}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">${task.task}</p>
                    ${currentFilterState ? `<div class="flex items-center gap-2 mb-3">
                        <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full">
                            Assigned to: ${task.assigned_to}
                        </span>
                        ${task.is_created_by_me ? '<span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full">Created by me</span>' : 
                          `<span class="text-xs px-2 py-1 bg-gray-100 text-gray-800 rounded-full">Created by: ${task.created_by}</span>`}
                    </div>` : ''}
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-green-600 font-medium">Completed</span>
                        <span class="text-sm text-gray-500">
                            ${task.timestamp ? formatDateTime(task.timestamp) : ''}
                        </span>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2 flex-1">
                            <h4 class="font-medium text-gray-800 truncate">${task.file_number}</h4>
                            ${getUrgencyBadge(task.urgency)}
                        </div>
                        <span class="text-sm text-gray-500 whitespace-nowrap ml-2">
                            ${task.date ? formatDate(task.date) : ''}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">${task.task}</p>
                    ${currentFilterState ? `<div class="flex flex-wrap items-center gap-1 mb-3">
                        <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full">
                            Assigned to: ${task.assigned_to}
                        </span>
                        ${task.is_created_by_me ? '<span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full">Created by me</span>' : 
                          `<span class="text-xs px-2 py-1 bg-gray-100 text-gray-800 rounded-full">Created by: ${task.created_by}</span>`}
                    </div>` : ''}
                    <div class="flex justify-between items-center">
                        <span class="text-sm ${getDateStatusColor(task.date)}">
                            ${getDateStatus(task.date)}
                        </span>
                        ${getStatusButtons(status)}
                    </div>
                `;
            }

            return div;
        }

        function getBorderColor(status, urgency = 'medium') {
            if (status === 'completed') return 'green';
            
            // For to_do and in_progress, use urgency colors
            switch(urgency) {
                case 'urgent': return 'red';
                case 'high': return 'orange';
                case 'medium': return 'yellow';
                case 'low': return 'blue';
                default: return 'gray';
            }
        }

        function getUrgencyBadge(urgency) {
            const badges = {
                'urgent': '<span class="text-xs px-2 py-1 bg-red-100 text-red-800 rounded-full font-medium">🔥 Urgent</span>',
                'high': '<span class="text-xs px-2 py-1 bg-orange-100 text-orange-800 rounded-full font-medium">⚠️ High</span>',
                'medium': '<span class="text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full font-medium">📋 Medium</span>',
                'low': '<span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full font-medium">📝 Low</span>'
            };
            return badges[urgency] || badges['medium'];
        }

        function getDateStatusColor(dateStr) {
            if (!dateStr) return 'text-gray-500';
            
            const today = new Date();
            const taskDate = new Date(dateStr);
            const diffTime = taskDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return 'text-red-600 font-medium'; // Overdue
            if (diffDays === 0) return 'text-red-500 font-medium'; // Due today
            if (diffDays === 1) return 'text-orange-500 font-medium'; // Due tomorrow
            if (diffDays <= 3) return 'text-yellow-600'; // Due soon
            return 'text-gray-500'; // Future
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-UK', { month: 'short', day: 'numeric' ,year: 'numeric'});
        }

        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-UK', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getDateStatus(dateStr) {
            if (!dateStr) return '';

            const date = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            date.setHours(0, 0, 0, 0);

            if (date < today) {
                return '<span class="text-red-600 font-medium">Overdue</span>';
            } else if (date.getTime() === today.getTime()) {
                return '<span class="text-orange-600 font-medium">Due Today</span>';
            } else {
                return 'Due ' + formatDate(dateStr);
            }
        }

        function getStatusButtons(status) {
            switch(status) {
                case 'to_do':
                    return '<button class="task-status-btn px-2 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600" data-new-status="in_progress">Start</button>';
                case 'in_progress':
                    return `<div class="flex gap-1">
                        <button class="task-status-btn px-2 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600" data-new-status="to_do">Back</button>
                        <button class="task-status-btn px-2 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600" data-new-status="completed">Done</button>
                    </div>`;
                default:
                    return '';
            }
        }

        // Form submission handler
        addTaskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(addTaskForm);
            const taskData = {
                file_number: formData.get('file_number'),
                person: formData.get('person'),
                task: formData.get('task'),
                date: formData.get('date'),
                urgency: formData.get('urgency'),
                status: formData.get('status')
            };

            createTask(taskData);
        });

        // Load modal data (file numbers and users)
        function loadModalData() {
            // Load file numbers
            fetch('/api/get-files/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.files) {
                        allFiles = data.files;
                        filterFiles(''); // Show all files initially
                    } else {
                        console.error('Files API returned error:', data.error);
                        allFiles = [];
                    }
                })
                .catch(error => {
                    console.error('Error loading files:', error);
                    allFiles = [];
                });

            // Load users
            fetch('/api/get-users/')
                .then(response => response.json())
                .then(data => {
                    const personSelect = document.getElementById('person');
                    personSelect.innerHTML = '<option value="">Select a person...</option>';
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.name;
                        personSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading users:', error));

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        // Create new task
        function createTask(taskData) {
            fetch('/api/create-task/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(taskData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    modal.classList.add('hidden');
                    resetForm();
                    // Reload tasks to show the new one
                    Object.keys(containers).forEach(status => {
                        containers[status].innerHTML = '';
                        loadedTasks[status] = 0;
                    });
                    loadInitialTasks();
                    alert('Task created successfully!');
                } else {
                    alert('Error creating task: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating task');
            });
        }

        // Filter files based on search term
        function filterFiles(searchTerm) {
            if (!allFiles || allFiles.length === 0) {
                return;
            }

            if (!fileOptions) {
                return;
            }

            const filteredFiles = allFiles.filter(file => 
                file.display_text && file.display_text.toLowerCase().includes(searchTerm || '')
            );

            fileOptions.innerHTML = '';
            
            if (filteredFiles.length === 0) {
                if (noFilesFound) {
                    noFilesFound.classList.remove('hidden');
                }
            } else {
                if (noFilesFound) {
                    noFilesFound.classList.add('hidden');
                }
                filteredFiles.forEach(file => {
                    const option = document.createElement('div');
                    option.className = 'px-3 py-2 text-sm cursor-pointer hover:bg-gray-100 border-b border-gray-100 last:border-b-0';
                    option.innerHTML = `
                        <div class="font-medium text-gray-900">${file.file_number || 'N/A'}</div>
                        <div class="text-gray-500 text-xs mt-1">${file.description || 'No description'}</div>
                    `;
                    option.addEventListener('click', function() {
                        selectFile(file);
                    });
                    fileOptions.appendChild(option);
                });
            }
        }

        // Select a file from dropdown
        function selectFile(file) {
            if (fileSearchInput && file.display_text) {
                fileSearchInput.value = file.display_text;
            }
            if (fileHiddenInput && file.id) {
                fileHiddenInput.value = file.id;
            }
            if (fileDropdown) {
                fileDropdown.classList.add('hidden');
            }
        }

        // Reset form
        function resetForm() {
            addTaskForm.reset();
            document.getElementById('urgency').value = 'medium';
            document.getElementById('status').value = 'to_do';
            
            // Reset file search
            fileSearchInput.value = '';
            fileHiddenInput.value = '';
            fileDropdown.classList.add('hidden');
        }
    });
  </script>
  {% endblock %}
</div>
