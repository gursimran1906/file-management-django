{% extends 'base.html' %} 
{% block title %}Dashboard{% endblock %} 
{% block container %}
{% load utils %}
<div class='grid md:grid-cols-2 gap-4 mt-2'>
    <h1 class='div-container md:w-fit h-fit text-3xl font-medium '>Hello ðŸ‘‹ {{request.user.first_name}}</h1>
    {% comment %} <div class='div-container md:justify-self-end '>
        <h3 class='text-xl mb-4 text-center'>Actions</h3>
       <div>
          <a id="editButton" class="btn-primary" type="submit" >Edit Matter</a>
          <a class="btn-primary " >Frontsheet</a>
        </div>
    </div> {% endcomment %}
</div>

    
    <div class="mt-4 h-screen pb-4 space-y-4 ">

        <div class='h-full md:h-1/3 grid grid-cols-1 md:grid-cols-9 gap-4'>
            <!-- Recent Files -->
            <div class="overflow-y-scroll div-container md:col-span-3">
                <h2 class="text-xl mb-2">Files</h2>
                <div class='overflow-x-scroll rounded-lg border'>
                    <table class='text-gray-600 w-full'>
                        <tr class='w-full border-b rounded-t-lg even:bg-white odd:bg-gray-50 font-medium'>
                            <td class='py-2 px-2 '>File number</td>
                            <td class='py-2 px-2 '>Description</td>
                            <td class='py-2 px-2 '>Client(s)</td>
                        </tr>
                        {% for file in files %}
                        <tr class="{% if forloop.last %}rounded-b-lg border-b-0 {% endif %}border-b even:bg-white odd:bg-gray-50">
                            <td class='py-2 px-2 '><a class='link' href="{% url 'home' file.file_number %}">{{file.file_number}}</a></td>
                            <td class='py-2 px-2 '>{{file.matter_description}}</td>
                            <td class='py-2 px-2 '>{{file.client1.name}} {{file.client2.name}}</td>

                        </tr>
                        {% empty %}
                        <tr class=" text-green-700">
                            <td class="py-2 px-2" colspan='3' >No files to show</td>
                        </tr>
                        {% endfor %}
                    
                    </table>
                </div>
            </div>

            <!-- Next Work -->
            <div class="overflow-scroll div-container md:col-span-3">
                <h2 class="text-xl mb-2">Upcoming Tasks</h2>
                <ul>
                    {% for work in user_next_works %}
                    <ul class="mt-4 list">
                        <li class="list-item bg-gray-50 rounded-t-lg">File Number: {{work.file_number}}</li>
                        <li class="list-item">Task(s) Required: {{work.task}}</li>
                        <li class="list-item bg-gray-50">Date: {{work.date|date:"d/m/Y"}}</li>
                        <li class="list-item">Assigned on: {{work.timestamp|date:"d/m/Y @ h:iA"}}</li>
                        <li class='list-item bg-gray-50 rounded-b-lg'><a class='link' href="{% url 'edit_next_work' work.id %}">Edit</a></li>
                    </ul>
                    
                {% endfor %}
                </ul>
            </div>

            <!-- Recent Emails -->
            <div class="overflow-scroll div-container md:col-span-3">
                <div class='mb-4 flex justify-between'>
                    <h2 class="text-xl">Emails</h2>
                    <span class='text-xs text-right text-gray-500 p-2 rounded-lg align-middle'>Latest 100 emails</span>
                </div>
                <div id="accordion-color" data-accordion="collapse" data-active-classes="bg-blue-100 dark:bg-gray-800 text-blue-600 dark:text-white rounded-b-none">
                    {% for email in last_100_emails %}
                    
                        <h2 id="accordion-color-heading-{{ email.id }}">
                            <button type="button" class="flex items-center justify-between text-left w-full p-4 rtl:text-right
                            bg-white text-gray-900 border border-gray-200 
                            {% if forloop.first %}rounded-t-lg {% endif %} {% if forloop.last %} rounded-b-lg {% endif %} hover:shadow
                            dark:border-gray-700 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 gap-3" 
                            data-accordion-target="#accordion-color-body-{{ email.id }}" aria-expanded="false" aria-controls="accordion-color-body-{{ email.id }}">
                                {{ email.time|date:'d/m/Y @ H:i' }} Email 
                                {% if email.is_sent %}to 
                                    {% with email.receiver|jsonify as receiver %}
                                        {{ receiver.0.emailAddress.name }}
                                    {% endwith %}
                                {% else %}from 
                                    {% with email.sender|jsonify as sender %}
                                        {{ sender.emailAddress.name }}
                                    {% endwith %}
                                {% endif %} 
                                - Subject: {{ email.subject }}
                                <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
                                </svg>
                            </button>
                        </h2>
                        <div id="accordion-color-body-{{ email.id }}" class="hidden overflow-scroll bg-white dark:bg-gray-900" aria-labelledby="accordion-color-heading-{{ email.id }}">
                            <div class="overflow-scroll {% if forloop.last %} rounded-b-lg shadow{% endif %} p-4 border border-gray-200 dark:border-gray-700">
                                <table class="w-full table-auto ">
                                    <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                        <td class="px-1 py-2">
                                            <b>From:</b>
                                        </td>
                                        <td class="px-1 py-2 break-words">
                                            {% with email.sender|jsonify as sender %}
                                                <p class="break-words">{{ sender.emailAddress.name }} ({{ sender.emailAddress.address }}); </p>
                                            {% endwith %}
                                        </td>
                                    </tr>
                                    <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                        <td class="px-1 py-2">
                                            <b>To:</b>
                                        </td>
                                        <td class="px-1 py-2 break-words">
                                            {% with email.receiver|jsonify as receivers %}
                                                {% for receiver in receivers %}
                                                    <p class="break-words">{{ receiver.emailAddress.name }} ({{ receiver.emailAddress.address }}); </p>
                                                {% endfor %}
                                            {% endwith %}
                                        </td>
                                    </tr>
                                    <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                        <td class="px-1 py-2">
                                            <b>Time:</b>
                                        </td>
                                        <td class="px-1 py-2 break-words">
                                            {{ email.time|date:'d/m/Y @ H:i' }}
                                        </td>
                                    </tr>
                                    <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                        <td class="px-1 py-2 break-words">
                                            <b>Subject:</b>
                                        </td>
                                        <td class="px-1 py-2 break-words">
                                            {{ email.subject }}
                                        </td>
                                    </tr>
                                    <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                        <td class="px-1 py-2">
                                            <b>Link:</b>
                                        </td>
                                        <td class="px-1 py-2 break-words">
                                            <a class="link break-words" href="{{ email.link }}">See Email</a>
                                        </td>
                                    </tr>
                                    <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                        <td class="px-1 py-2">
                                            <b>Body:</b>
                                        </td>
                                        <td class="px-1 py-2 break-words">
                                            {{ email.body }}
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                
                    {% endfor %}
                </div>
            </div>
            
            
    
            <!-- Chart.js Visualization -->
            {% comment %} <div class="bg-white p-4 rounded-lg shadow-md col-span-1 lg:col-span-2">
                <h2 class="text-xl font-semibold mb-2">Work Statistics</h2>
                <canvas id="workChart"></canvas>
            </div> {% endcomment %}
        </div>
        <div class='h-full md:h-1/2 grid grid-cols-1 md:grid-cols-7 gap-4'>
            
            <!-- Risk Assessment -->
            <div class="div-container md:col-span-2 overflow-scroll">
                <div class='mb-2 flex justify-between'>
                    <h2 class="text-xl ">Risk Assessments</h2>
                    <span class='text-xs text-gray-500 p-2 rounded-lg align-middle'>older than 11 months</span>
                </div>
                <ul class='rounded-lg '>
                    {% for file in risk_assessments_due_files %}
                        {% if file.date_of_last_risk_assessment %}
                            <li class="hover:bg-gray-50 border-b py-2"><a href="{% url 'home' file.file_number %}">{{ file.file_number }}</a> - {{ file.date_of_last_risk_assessment|date:"d/m/y" }}</li>
                        {% else %}
                            <li class="hover:bg-gray-50 border-b py-2"><a class='link'href="{% url 'home' file.file_number %}">{{ file.file_number }}</a> - <span class='text-red-700'>None done</span></li>
                        {% endif %}

                        {% empty %}
                        <li class="text-sm border-t border-b py-2 text-green-700">No Risk Assessments due</li>
                    {% endfor %}
                </ul>
            </div>
            <!-- AML Checks Due -->
            <div class="div-container md:col-span-2 overflow-scroll">
                <div class='mb-2 flex justify-between'>
                    <h2 class="text-xl ">AML Checks</h2>
                    <span class='text-xs text-right text-gray-500 p-2 rounded-lg align-middle'>older than 11 months</span>
                </div>
                <ul>
                    {% for check in aml_checks_due %}
                        <li class="border-b py-2"><a class="link" href="{% url 'edit_client' check.client_id %}">{{ check.client_name }}</a> - {{ check.date_of_last_aml|date:"d/m/Y" }}</li>
                    {% empty %}
                        <li class="text-sm border-t border-b py-2 text-green-700">No Client AML Checks Due</li>
                    {% endfor %}
                </ul>
            </div>
            <!-- Overdue Invoices -->
            <div class="div-container md:col-span-3 overflow-scroll">
                <h2 class="text-xl mb-2">Overdue Invoices</h2>
                <ul>
                    {% for invoice in unsettled_invoices %}
                        <li class="border-b py-2">
                            {{invoice.file_number.file_number}} - 
                            <a class="link" href="{% url 'download_invoice' invoice.id %}">{{ invoice.invoice_number }}</a> - 
                            {% for cost, cost_desc in invoice.our_costs|zip:invoice.our_costs_desc %}
                                {{ cost_desc }} - {{ cost }}<br>
                            {% endfor %}
                        </li>
                        {% empty %}
                        <li class="text-sm border-t border-b py-2 text-green-700">No Invoices Overdue</li>
    
                    {% endfor %}
                </ul>
            </div>
            

            
            
        </div>
        
        




{% endblock %}
