{% extends 'base.html' %}
{% block title %}Correspondence{% endblock %} 
{% load utils %}
{% block container_class %}container{% endblock %} 
{% block container %}
<div class='grid grid-cols-1 mt-2 '>
    <h1 class='div-container w-fit text-3xl font-medium'>{{ file_number }} | Correspondence</h1>
</div>
<div class='mt-4 grid grid-cols-1 md:grid-cols-2 gap-4'>
    <div class='grid grid-cols-1 gap-4'>
       
        <div id="accordion-color" data-accordion="collapse" data-active-classes="bg-blue-100 dark:bg-gray-800 text-blue-600 dark:text-white rounded-b-none">
            {% for email in emails %}
            
                <h2 id="accordion-color-heading-{{ email.id }}">
                    <button type="button" class="flex items-center justify-between text-left w-full p-4  rtl:text-right
                    bg-white text-gray-900 border border-gray-200 
                    {% if forloop.first %}rounded-t-lg shadow {% endif %} {% if forloop.last %} rounded-b-lg shadow {% endif %}
                    dark:border-gray-700 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 gap-3" 
                    data-accordion-target="#accordion-color-body-{{ email.id }}" aria-expanded="false" aria-controls="accordion-color-body-{{ email.id }}">
                        {{ email.time|date:'d/m/Y @ H:i' }} Email 
                        {% if email.is_sent %}to 
                            {% with email.receiver|jsonify as receiver %}
                                {{ receiver.0.emailAddress.name }}
                            {% endwith %}
                        {% else %}from 
                            {% with email.sender|jsonify as sender %}
                                {{ sender.emailAddress.name }}
                            {% endwith %}
                        {% endif %} 
                        - Subject: {{ email.subject }}
                        <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
                        </svg>
                    </button>
                </h2>
                <div id="accordion-color-body-{{ email.id }}" class="hidden overflow-scroll bg-white dark:bg-gray-900" aria-labelledby="accordion-color-heading-{{ email.id }}">
                    <div class="{% if forloop.last %} rounded-b-lg shadow{% endif %} p-4 border border-gray-200 dark:border-gray-700">
                        <table class="w-full table-auto">
                            <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                <td class="px-1 py-2">
                                    <b>From:</b>
                                </td>
                                <td class="px-1 py-2 break-words">
                                    {% with email.sender|jsonify as sender %}
                                        <p class="break-words">{{ sender.emailAddress.name }} ({{ sender.emailAddress.address }}); </p>
                                    {% endwith %}
                                </td>
                            </tr>
                            <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                <td class="px-1 py-2">
                                    <b>To:</b>
                                </td>
                                <td class="px-1 py-2 break-words">
                                    {% with email.receiver|jsonify as receivers %}
                                        {% for receiver in receivers %}
                                            <p class="break-words">{{ receiver.emailAddress.name }} ({{ receiver.emailAddress.address }}); </p>
                                        {% endfor %}
                                    {% endwith %}
                                </td>
                            </tr>
                            <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                <td class="px-1 py-2">
                                    <b>Time:</b>
                                </td>
                                <td class="px-1 py-2 break-words">
                                    {{ email.time|date:'d/m/Y @ H:i' }}
                                </td>
                            </tr>
                            <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                <td class="px-1 py-2 break-words">
                                    <b>Subject:</b>
                                </td>
                                <td class="px-1 py-2 break-words">
                                    {{ email.subject }}
                                </td>
                            </tr>
                            <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                <td class="px-1 py-2">
                                    <b>Link:</b>
                                </td>
                                <td class="px-1 py-2 break-words">
                                    <a class="link break-words" href="{{ email.link }}">See Email</a>
                                </td>
                            </tr>
                            <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                <td class="px-1 py-2">
                                    <b>Body:</b>
                                </td>
                                <td class="px-1 py-2 break-words">
                                    {{ email.body|linebreaksbr|safe }}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
          
            {% endfor %}
       
            {% for letter in letters %}
            
                <h2 id="accordion-color-heading-letter-{{ letter.id }}">
                    <button type="button" class="flex items-center justify-between text-left w-full p-4  rtl:text-right
                    bg-white text-gray-900 border border-gray-200 
                    {% if forloop.first %}rounded-t-lg shadow mt-4{% endif %} {% if forloop.last %} rounded-b-lg shadow {% endif %}
                    dark:border-gray-700 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 gap-3" 
                    data-accordion-target="#accordion-color-body-letter-{{ letter.id }}" aria-expanded="false" aria-controls="accordion-color-body-letter-{{ letter.id }}">
                        {{ letter.date|date:'d/m/Y' }} Letter 
                        {% if letter.sent %}to 
                            {{ letter.to_or_from }}
                        {% else %}from 
                            {{ letter.to_or_from }}
                        {% endif %} 
                        - Subject: {{ letter.subject_line }}
                        <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
                        </svg>
                    </button>
                </h2>
                <div id="accordion-color-body-letter-{{ letter.id }}" class="hidden overflow-scroll bg-white dark:bg-gray-900" aria-labelledby="accordion-color-heading-letter-{{ letter.id }}">
                    <div class="text-wrap {% if forloop.last %} rounded-b-lg shadow{% endif %} p-4 border border-gray-200 dark:border-gray-700">
                        <table class="w-full table-auto">
                            <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                <td class="px-1 py-2">
                                    <b>Date:</b>
                                </td>
                                <td class="px-1 py-2 break-words">
                                    {{ letter.date|date:'d/m/Y' }}
                                </td>
                            </tr>
                            <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                <td class="px-1 py-2">
                                    <b>Subject:</b>
                                </td>
                                <td class="px-1 py-2 break-words">
                                    {{ letter.subject_line }}
                                </td>
                            </tr>
                            <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                <td class="px-1 py-2">
                                    <b>Person Attended:</b>
                                </td>
                                <td class="px-1 py-2 break-words">
                                    {{ letter.person_attended }}
                                </td>
                            </tr>
                            <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                <td class="px-1 py-2">
                                    <b>Is Charged:</b>
                                </td>
                                <td class="px-1 py-2 break-words">
                                    {{ letter.is_charged }}
                                </td>
                            </tr>
                            <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                <td class="px-1 py-2">
                                    <b>Edit:</b>
                                </td>
                                <td class="px-1 py-2 break-words">
                                    <a class='link' href="{% url 'edit_letter' letter.id %}">Edit</a>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
          
            {% endfor %}
        </div>
   
    </div>
   
    <div class=''>
        <div class='div-container flex gap-4 w-fit'>
            <button class="btn btn-primary" type="button" onclick="toggleCollapse('letterForm');" aria-expanded="true" aria-controls="FileSummary">
                Add Letter
            </button>
        </div>
        <div class="" >
            <div class="h-0 overflow-hidden mt-4 " id="letterForm" aria-expanded="true" >
                <form class='bg-white border rounded-lg p-4 space-y-2' method='post' action="{% url 'add_letter' file_number %}">
                    <h4 class='text-2xl mb-2'>Add Letter</h4>
                    {{letter_form.as_p}}
                    {% csrf_token %}
                    <button class='btn btn-primary' type='submit'>Submit</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %} 